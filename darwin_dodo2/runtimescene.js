var gdjs;!function(e){let t;var s;e.RuntimeScene=class{constructor(s){this._eventsFunction=null,this._lastId=0,this._name="",this._gameStopRequested=!1,this._requestedScene="",this._isLoaded=!1,this._isJustResumed=!1,this._backgroundColor=0,this._allInstancesList=[],this._layersCameraCoordinates={},this._instancesRemoved=[],this._profiler=null,this._debugDrawEnabled=!1,this._debugDrawShowHiddenInstances=!1,this._debugDrawShowPointsNames=!1,this._debugDrawShowCustomPoints=!1,this._onProfilerStopped=null,this._instances=new Hashtable,this._instancesCache=new Hashtable,this._objects=new Hashtable,this._objectsCtor=new Hashtable,this._layers=new Hashtable,this._initialBehaviorSharedData=new Hashtable,this._renderer=new e.RuntimeSceneRenderer(this,s?s.getRenderer():null),this._variables=new e.VariablesContainer,this._runtimeGame=s,this._timeManager=new e.TimeManager,this._requestedChange=t.CONTINUE,this._onceTriggers=new e.OnceTriggers,this.onGameResolutionResized()}enableDebugDraw(e,t,s,i){this._debugDrawEnabled&&!e&&this.getRenderer().clearDebugDraw(),this._debugDrawEnabled=e,this._debugDrawShowHiddenInstances=t,this._debugDrawShowPointsNames=s,this._debugDrawShowCustomPoints=i}onGameResolutionResized(){for(const e in this._layers.items)this._layers.items.hasOwnProperty(e)&&this._layers.items[e].onGameResolutionResized();this._renderer.onGameResolutionResized()}loadFromScene(t){if(!t)return void console.error("loadFromScene was called without a scene");this._isLoaded&&this.unloadScene(),this._runtimeGame&&this._runtimeGame.getRenderer().setWindowTitle(t.title),this._name=t.name,this.setBackgroundColor(t.r,t.v,t.b);for(let e=0,s=t.layers.length;e<s;++e)this.addLayer(t.layers[e]);this._variables=new e.VariablesContainer(t.variables);for(let e=0,s=t.behaviorsSharedData.length;e<s;++e){const s=t.behaviorsSharedData[e];this.setInitialSharedDataForBehavior(s.name,s)}const s=this.getGame().getInitialObjectsData();for(let e=0,t=s.length;e<t;++e)this.registerObject(s[e]);for(let e=0,s=t.objects.length;e<s;++e)this.registerObject(t.objects[e]);if(this.createObjectsFrom(t.instances,0,0,!0),this._setLayerDefaultZOrders(),this.setEventsGeneratedCodeFunction(t),this._onceTriggers=new e.OnceTriggers,this._runtimeGame&&!this._runtimeGame.wasFirstSceneLoaded())for(let t=0;t<e.callbacksFirstRuntimeSceneLoaded.length;++t)e.callbacksFirstRuntimeSceneLoaded[t](this);for(let t=0;t<e.callbacksRuntimeSceneLoaded.length;++t)e.callbacksRuntimeSceneLoaded[t](this);t.stopSoundsOnStartup&&this._runtimeGame&&this._runtimeGame.getSoundManager().clearAll(),this._isLoaded=!0,this._timeManager.reset()}isObjectRegistered(e){return this._objects.containsKey(e)&&this._instances.containsKey(e)&&this._objectsCtor.containsKey(e)}registerObject(t){this._objects.put(t.name,t),this._instances.put(t.name,[]);const s=e.getObjectConstructor(t.type);this._objectsCtor.put(t.name,s),s.supportsReinitialization&&this._instancesCache.put(t.name,[])}updateObject(e){this.isObjectRegistered(e.name)||console.warn("Tried to call updateObject for an object that was not registered ("+e.name+"). Call registerObject first."),this._objects.put(e.name,e)}unregisterObject(e){const t=this._instances.get(e);if(t){const e=t.slice();for(let t=0;t<e.length;t++)this.markObjectForDeletion(e[t]);this._cacheOrClearRemovedInstances()}this._objects.remove(e),this._instances.remove(e),this._instancesCache.remove(e),this._objectsCtor.remove(e)}onPause(){for(let t=0;t<e.callbacksRuntimeScenePaused.length;++t)e.callbacksRuntimeScenePaused[t](this)}onResume(){this._isJustResumed=!0;for(let t=0;t<e.callbacksRuntimeSceneResumed.length;++t)e.callbacksRuntimeSceneResumed[t](this)}unloadScene(){if(this._isLoaded){this._profiler&&this.stopProfiler();for(let t=0;t<e.callbacksRuntimeSceneUnloading.length;++t)e.callbacksRuntimeSceneUnloading[t](this);this._constructListOfAllInstances();for(let e=0,t=this._allInstancesList.length;e<t;++e)this._allInstancesList[e].onDestroyFromScene(this);this._renderer&&this._renderer.onSceneUnloaded();for(let t=0;t<e.callbacksRuntimeSceneUnloaded.length;++t)e.callbacksRuntimeSceneUnloaded[t](this);this._layers=new Hashtable,this._variables=new e.VariablesContainer,this._initialBehaviorSharedData=new Hashtable,this._objects=new Hashtable,this._instances=new Hashtable,this._instancesCache=new Hashtable,this._eventsFunction=null,this._objectsCtor=new Hashtable,this._allInstancesList=[],this._instancesRemoved=[],this._lastId=0,this._onceTriggers=null,this._isLoaded=!1,this.onGameResolutionResized()}}createObjectsFrom(e,t,s,i){for(let n=0,r=e.length;n<r;++n){const r=e[n],a=r.name,o=this.createObject(a);null!==o&&(i&&(o.persistentUuid=r.persistentUuid||null),o.setPosition(r.x+t,r.y+s),o.setZOrder(r.zOrder),o.setAngle(r.angle),o.setLayer(r.layer),o.getVariables().initFrom(r.initialVariables,!0),o.extraInitializationFromInitialInstance(r))}}_setLayerDefaultZOrders(){if(this._runtimeGame.getGameData().properties.useDeprecatedZeroAsDefaultZOrder)return;const e={},t=this.getAdhocListOfAllInstances();for(let s=0,i=t.length;s<i;++s){const i=t[s];let n=i.getLayer();const r=i.getZOrder();(void 0===e[n]||e[n]<r)&&(e[n]=r)}for(let t in e)this.getLayer(t).setDefaultZOrder(e[t]+1)}setEventsGeneratedCodeFunction(t){const s=e[t.mangledName+"Code"];s&&s.func?this._eventsFunction=s.func:(console.log("Warning: no function found for running logic of scene "+this._name),this._eventsFunction=function(){})}setEventsFunction(e){this._eventsFunction=e}renderAndStep(s){this._profiler&&this._profiler.beginFrame(),this._requestedChange=t.CONTINUE,this._timeManager.update(s,this._runtimeGame.getMinimalFramerate()),this._profiler&&this._profiler.begin("objects (pre-events)"),this._updateObjectsPreEvents(),this._profiler&&this._profiler.end("objects (pre-events)"),this._profiler&&this._profiler.begin("callbacks and extensions (pre-events)");for(let t=0;t<e.callbacksRuntimeScenePreEvents.length;++t)e.callbacksRuntimeScenePreEvents[t](this);this._profiler&&this._profiler.end("callbacks and extensions (pre-events)"),this._profiler&&this._profiler.begin("events"),null!==this._eventsFunction&&this._eventsFunction(this),this._profiler&&this._profiler.end("events"),this._profiler&&this._profiler.begin("objects (post-events)"),this._updateObjectsPostEvents(),this._profiler&&this._profiler.end("objects (post-events)"),this._profiler&&this._profiler.begin("callbacks and extensions (post-events)");for(let t=0;t<e.callbacksRuntimeScenePostEvents.length;++t)e.callbacksRuntimeScenePostEvents[t](this);return this._profiler&&this._profiler.end("callbacks and extensions (post-events)"),this._profiler&&this._profiler.begin("objects (pre-render)"),this._updateObjectsPreRender(),this._profiler&&this._profiler.end("objects (pre-render)"),this._profiler&&this._profiler.begin("layers (effects update)"),this._updateLayers(),this._profiler&&this._profiler.end("layers (effects update)"),this._profiler&&this._profiler.begin("render"),this._debugDrawEnabled&&this._layersCameraCoordinates&&(this._updateLayersCameraCoordinates(1),this.getRenderer().renderDebugDraw(this._allInstancesList,this._layersCameraCoordinates,this._debugDrawShowHiddenInstances,this._debugDrawShowPointsNames,this._debugDrawShowCustomPoints)),this._isJustResumed=!1,this.render(),this._profiler&&this._profiler.end("render"),this._profiler&&this._profiler.endFrame(),!!this.getRequestedChange()}render(){this._renderer.render()}_updateLayersCameraCoordinates(e){this._layersCameraCoordinates=this._layersCameraCoordinates||{};for(const t in this._layers.items)if(this._layers.items.hasOwnProperty(t)){const s=this._layers.items[t];this._layersCameraCoordinates[t]=this._layersCameraCoordinates[t]||[0,0,0,0],this._layersCameraCoordinates[t][0]=s.getCameraX()-s.getCameraWidth()/2*e,this._layersCameraCoordinates[t][1]=s.getCameraY()-s.getCameraHeight()/2*e,this._layersCameraCoordinates[t][2]=s.getCameraX()+s.getCameraWidth()/2*e,this._layersCameraCoordinates[t][3]=s.getCameraY()+s.getCameraHeight()/2*e}}_updateLayers(){for(const e in this._layers.items)this._layers.items.hasOwnProperty(e)&&this._layers.items[e].update(this)}_updateObjectsPreRender(){if(this._timeManager.isFirstFrame()){this._constructListOfAllInstances();for(let e=0,t=this._allInstancesList.length;e<t;++e){const t=this._allInstancesList[e];t.getRendererObject()&&(t.getRendererObject().visible=!t.isHidden()),t.updatePreRender(this)}}else{this._updateLayersCameraCoordinates(2),this._constructListOfAllInstances();for(let e=0,t=this._allInstancesList.length;e<t;++e){const t=this._allInstancesList[e],s=this._layersCameraCoordinates[t.getLayer()],i=t.getRendererObject();if(s&&i){if(t.isHidden())i.visible=!1;else{const e=t.getVisibilityAABB();e&&(e.min[0]>s[2]||e.min[1]>s[3]||e.max[0]<s[0]||e.max[1]<s[1])?i.visible=!1:i.visible=!0}t.updatePreRender(this)}}}}_cacheOrClearRemovedInstances(){for(let e=0,t=this._instancesRemoved.length;e<t;++e){const t=this._instancesCache.get(this._instancesRemoved[e].getName());t&&t.length<128&&t.push(this._instancesRemoved[e])}this._instancesRemoved.length=0}_constructListOfAllInstances(){let e=0;for(const t in this._instances.items)if(this._instances.items.hasOwnProperty(t)){const s=this._instances.items[t],i=e;e+=s.length;for(let e=0,t=s.length;e<t;++e)i+e<this._allInstancesList.length?this._allInstancesList[i+e]=s[e]:this._allInstancesList.push(s[e])}this._allInstancesList.length=e}_updateObjectsPreEvents(){this._constructListOfAllInstances();for(let e=0,t=this._allInstancesList.length;e<t;++e){const t=this._allInstancesList[e],s=t.getElapsedTime(this);if(t.hasNoForces())t.update(this);else{const e=t.getAverageForce(),i=s/1e3;t.setX(t.getX()+e.getX()*i),t.setY(t.getY()+e.getY()*i),t.update(this),t.updateForces(i)}t.updateTimers(s),this._allInstancesList[e].stepBehaviorsPreEvents(this)}this._cacheOrClearRemovedInstances()}_updateObjectsPostEvents(){this._cacheOrClearRemovedInstances(),this._constructListOfAllInstances();for(let e=0,t=this._allInstancesList.length;e<t;++e)this._allInstancesList[e].stepBehaviorsPostEvents(this);this._cacheOrClearRemovedInstances()}setBackgroundColor(t,s,i){this._backgroundColor=parseInt(e.rgbToHex(t,s,i),16)}getBackgroundColor(){return this._backgroundColor}getName(){return this._name}updateObjectsForces(){for(const e in this._instances.items)if(this._instances.items.hasOwnProperty(e)){const t=this._instances.items[e];for(let e=0,s=t.length;e<s;++e){const s=t[e];if(!s.hasNoForces()){const e=s.getAverageForce(),t=s.getElapsedTime(this)/1e3;s.setX(s.getX()+e.getX()*t),s.setY(s.getY()+e.getY()*t),s.updateForces(t)}}}}addObject(e){this._instances.containsKey(e.name)||this._instances.put(e.name,[]),this._instances.get(e.name).push(e)}getObjects(e){return this._instances.containsKey(e)||(console.log('RuntimeScene.getObjects: No instances called "'+e+'"! Adding it.'),this._instances.put(e,[])),this._instances.get(e)}createObject(e){if(!this._objectsCtor.containsKey(e)||!this._objects.containsKey(e))return null;const t=this._instancesCache.get(e),s=this._objectsCtor.get(e);let i;return t&&0!==t.length?(i=t.pop()).reinitialize(this._objects.get(e)):i=new s(this,this._objects.get(e)),this.addObject(i),i}markObjectForDeletion(t){if(-1===this._instancesRemoved.indexOf(t)&&this._instancesRemoved.push(t),this._instances.containsKey(t.getName())){const e=t.id,s=this._instances.get(t.getName());for(let t=0,i=s.length;t<i;++t)if(s[t].id==e){s.splice(t,1);break}}t.onDestroyFromScene(this);for(let s=0;s<e.callbacksObjectDeletedFromScene.length;++s)e.callbacksObjectDeletedFromScene[s](this,t)}createNewUniqueId(){return this._lastId++,this._lastId}getRenderer(){return this._renderer}getGame(){return this._runtimeGame}getVariables(){return this._variables}getInitialSharedDataForBehavior(e){const t=this._initialBehaviorSharedData.get(e);return t||(console.error("Can't find shared data for behavior with name:",e),null)}setInitialSharedDataForBehavior(e,t){this._initialBehaviorSharedData.put(e,t)}getLayer(e){return this._layers.containsKey(e)?this._layers.get(e):this._layers.get("")}hasLayer(e){return this._layers.containsKey(e)}addLayer(t){this._layers.put(t.name,new e.Layer(t,this))}removeLayer(e){const t=this.getAdhocListOfAllInstances();for(let s=0;s<t.length;++s){const i=t[s];i.getLayer()===e&&i.setLayer("")}this._layers.remove(e)}setLayerIndex(e,t){const s=this._layers.get(e);s&&this._renderer.setLayerIndex(s,t)}getAllLayerNames(e){this._layers.keys(e)}getTimeManager(){return this._timeManager}getSoundManager(){return this._runtimeGame.getSoundManager()}getRequestedChange(){return this._requestedChange}getRequestedScene(){return this._requestedScene}requestChange(e,t){this._requestedChange=e,t&&(this._requestedScene=t)}getProfiler(){return this._profiler}startProfiler(t){this._profiler||(this._profiler=new e.Profiler,this._onProfilerStopped=t)}stopProfiler(){if(!this._profiler)return;const e=this._profiler,t=this._onProfilerStopped;this._profiler=null,this._onProfilerStopped=null,t&&t(e)}getOnceTriggers(){return this._onceTriggers}getAdhocListOfAllInstances(){return this._constructListOfAllInstances(),this._allInstancesList}sceneJustResumed(){return this._isJustResumed}},(s=t=e.SceneChangeRequest||(e.SceneChangeRequest={}))[s.CONTINUE=0]="CONTINUE",s[s.PUSH_SCENE=1]="PUSH_SCENE",s[s.POP_SCENE=2]="POP_SCENE",s[s.REPLACE_SCENE=3]="REPLACE_SCENE",s[s.CLEAR_SCENES=4]="CLEAR_SCENES",s[s.STOP_GAME=5]="STOP_GAME"}(gdjs||(gdjs={}));